syntax = "proto3";
package io.elkia.eventing.v1alpha1;

option go_package = "pkg/api/eventing/v1alpha1";

enum DialogErrorCode {
  OUTDATED_CLIENT = 0;
  UNEXPECTED_ERROR = 1;
  MAINTENANCE = 2;
  SESSION_ALREADY_USED = 3;
  UNVALID_CREDENTIALS = 4;
  CANT_AUTHENTICATE = 5;
  USER_BLOCKLISTED = 6;
  COUNTRY_BLACKLISTED = 7;
  BAD_CASE = 8;
}

message DialogErrorFrame { DialogErrorCode code = 1; }

message DialogInfoFrame { string content = 1; }

message AuthLoginFrame {
  string identifier = 2;
  string password = 3;
  string client_version = 5;
  string client_checksum = 7;
}

message Endpoint {
  string host = 1;
  string port = 2;
  uint32 weight = 3;
  uint32 world_id = 4;
  uint32 channel_id = 5;
  string world_name = 6;
}

message EndpointListFrame {
  uint32 code = 1;
  repeated Endpoint endpoints = 2;
}

message AuthInteractRequest {
  oneof payload { AuthLoginFrame auth_login_frame = 1; }
}

message AuthInteractResponse {
  oneof payload {
    DialogErrorFrame dialog_error_frame = 1;
    DialogInfoFrame dialog_info_frame = 2;
    EndpointListFrame endpoint_list_frame = 3;
  }
}

service Auth {
  // AuthInteract is a bi-directional stream that is used to interact with the
  // auth server
  rpc AuthInteract(stream AuthInteractRequest)
      returns (stream AuthInteractResponse);

  // AuthLoginProduce send a login event to the auth server and returns a
  // stream of events
  rpc AuthLoginProduce(AuthLoginFrame) returns (stream AuthInteractResponse);
}

message AuthHandoffSyncFrame {
  uint32 sequence = 1;
  uint32 code = 2;
}

message AuthHandoffLoginIdentifierFrame {
  uint32 sequence = 1;
  string identifier = 2;
}

message AuthHandoffLoginPasswordFrame {
  uint32 sequence = 1;
  string password = 2;
}

message AuthHandoffLoginFrame {
  AuthHandoffLoginIdentifierFrame identifier_frame = 1;
  AuthHandoffLoginPasswordFrame password_frame = 2;
}

message AuthHandoffInteractRequest {
  oneof payload {
    AuthHandoffSyncFrame sync_frame = 1;
    AuthHandoffLoginFrame login_frame = 2;
  }
}

message AuthHandoffLoginSuccessFrame { string token = 1; }

message AuthHandoffInteractResponse {
  oneof payload { AuthHandoffLoginSuccessFrame login_success_frame = 1; }
}

message ChannelFrame {
  uint32 sequence = 1;
  oneof payload { bytes unknown_payload = 2; }
}

message ChannelInteractRequest {
  oneof payload { ChannelFrame channel_frame = 1; }
}

message ChannelInteractResponse {
  oneof payload {
    DialogErrorFrame dialog_error_frame = 1;
    DialogInfoFrame dialog_info_frame = 2;
  }
}

service Gateway {
  // AuthHandoffInteract is a bi-directional stream that is used to handoff
  // the auth server
  rpc AuthHandoffInteract(stream AuthHandoffInteractRequest)
      returns (stream AuthHandoffInteractResponse);

  // ChannelInteract is a bi-directional stream that is used to interact with
  // the channel server
  rpc ChannelInteract(stream ChannelInteractRequest)
      returns (stream ChannelInteractResponse);
}